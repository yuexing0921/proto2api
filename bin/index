#!/usr/bin/env node
"use strict";
const { Command } = require("commander"); // include commander in git clone of commander repo
const path = require("path");
const fse = require("fs-extra");
const { Glob } = require("glob");
const pkg = require("../package.json");
const resolve = (p) => path.resolve(p);
const program = new Command();

program
  .version(pkg.version)
  .option("--debug", "Load code with ts-node for debug")
  .requiredOption(
    "-d, --dir <type>",
    "Directory address of Protocol Buffers. eq: /path/pbdir or /path/hello.proto"
  )
  .requiredOption("-o, --output <type>", "Output api path")
  .option(
    "-t, --type <type>",
    "The type of IDL file, currently supports proto and swagger, the default is proto type",
    "proto"
  )
  .option("--apiName <type>", "apiName", "webapi")
  .option("--apiPath <type>", "apiPath", "~/utils/api")
  .option("--prefix <type>", "api prefix path", "")
  .option(
    "--ignore [ignore...]",
    "Ignore unnecessary generated pb files",
    "google|swagger"
  )
  .description(pkg.description)
  .action(async (opt) => {
    const dirPath = resolve(opt.dir);
    if (!fse.existsSync(dirPath)) {
      console.error(`The address ${dirPath} does not exist`);
      return process.exit(1);
    }
    let files = [];
    let swaggerData;
    if (opt.type === "swagger") {
      swaggerData = require(dirPath);
    } else {
      if (opt.dir.endsWith(".proto")) {
        files.push(dirPath);
      } else {
        files = await getPathsDir(dirPath + "/**/*.proto");
      }
    }

    const devMode = opt.debug;

    const output = resolve(opt.output);

    let ignore;
    if (typeof opt.ignore === "string") {
      ignore = new RegExp(opt.ignore);
    } else {
      ignore =
        opt.ignore && opt.ignore.join ? new RegExp(opt.ignore.join("|")) : null;
    }

    const options = {
      files,
      output: output.endsWith("/") ? output : output + "/",
      type: opt.type,
      apiName: opt.apiName,
      apiPath: opt.apiPath,
      apiPrefixPath: opt.prefix,
      swaggerData,
      ignore,
    };

    console.log(options);
    if (devMode) {
      require("ts-node").register({
        project: `${__dirname}/../tsconfig.spec.json`,
      });
      const { main } = require(`${__dirname}/../src/index`);
      main(options);
    } else {
      const { main } = require(`${__dirname}/../dist/index`);
      main(options);
    }
  });

program.parse();

function getPathsDir(dir) {
  return new Promise((resolve, reject) => {
    new Glob(dir, { mark: true, sync: false }, (err, files) => {
      if (err) {
        console.error("Glob error: ", err);
        return reject(err);
      }
      resolve(files);
    });
  });
}
